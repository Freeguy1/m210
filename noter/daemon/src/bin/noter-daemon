#!/usr/bin/python
# -*- coding: utf-8 -*-

# Standard modules.
import os
import sys

# Third-party modules.
import dbus
import dbus.service
import dbus.mainloop.glib

dbus.mainloop.glib.DBusGMainLoop(set_as_default=True)

import PyQt4.QtCore

# Project-specific modules.
import noter.core
import noter.daemon
import noter.daemon.input
import noter.daemon.pegatech

USAGE='%prog [OPTION]'

class M210Connection(object):

    def __init__(self, dirpath):
        hidraw0, hidraw1, event = noter.daemon.find_m210_paths(dirpath)
        self._event_fd = None
        self._event_fd = os.open(event, os.O_RDWR)
        noter.daemon.input.grab_event_device(self._event_fd)
        self.m210 = noter.daemon.pegatech.M210((hidraw0, hidraw1))

    def __del__(self):
        if self._event_fd is not None:
            # self._event_fd might be None if self.__init__ fails for
            # some reason.
            noter.daemon.input.release_event_device(self._event_fd)

class Daemon(dbus.service.Object):

    def __init__(self, bus):
        dbus.service.Object.__init__(self, bus, noter.daemon.OBJECT_PATH)
        self._connected_devs = {}

    @dbus.service.method(noter.daemon.INTERFACE, in_signature='s')
    def connect(self, dirpath):
        if dirpath in self._connected_devs:
            raise ValueError("%s is already connected" % dirpath)
        self._connected_devs[dirpath] = M210Connection(dirpath)

    @dbus.service.method(noter.daemon.INTERFACE, in_signature='s')
    def disconnect(self, dirpath):
        self._connected_devs.pop(dirpath)

    @dbus.service.method(noter.daemon.INTERFACE, out_signature='as')
    def connected_devices(self):
        return list(self._connected_devs.keys())

def parse_args():
    parser = noter.core.OptionParser(usage=USAGE)
    parser.add_option('', '--no-daemon', action='store_false',
                      default=True, dest='daemon',
                      help='do not run as a daemon')
    return parser.parse_args(sys.argv)

def main():
    options, args = parse_args()

    if options.daemon:
        noter.daemon.daemonize()

    # Integrate to glib-mainloop. For some reason, DBusQtMainLoop does
    # not work.
    dbus.mainloop.glib.DBusGMainLoop(set_as_default=True)

    # Open a bus.
    bus = dbus.SystemBus()

    # Register a well-known name for the service.
    name = dbus.service.BusName(noter.daemon.NAME, bus)

    # Export a daemon object through the bus.
    daemon = Daemon(bus)

    app = PyQt4.QtCore.QCoreApplication([])
    app.exec_()

if __name__ == '__main__':
    main()
